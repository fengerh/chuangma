<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>川麻听牌计算器（基础+血流红中版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: #f5f5f5;
            font-family: "Microsoft YaHei", sans-serif;
            padding: 15px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
        }
        /* 新增：增强模式开关区 */
        .enhance-mode {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 8px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #e74c3c;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        .enhance-label {
            font-size: 15px;
            color: #333;
            font-weight: bold;
        }
        /* 新增：红中/缺门设置区（默认隐藏） */
        .hongzhong-setting {
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff5f5;
            border-radius: 8px;
        }
        .hongzhong-setting.show {
            display: flex;
        }
        .hongzhong-num, .quemen-select {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .hongzhong-num label, .quemen-select label {
            font-size: 14px;
            color: #e74c3c;
            font-weight: bold;
        }
        .hongzhong-num select, .quemen-select select {
            padding: 5px;
            border: 1px solid #e74c3c;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }
        /* 原有样式完全保留 */
        .color-tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }
        .color-tab {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-wan {
            background-color: #ffe5e5;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }
        .tab-wan.active {
            background-color: #e74c3c;
            color: white;
        }
        .tab-tiao {
            background-color: #e5ffe7;
            color: #2ecc71;
            border: 2px solid #2ecc71;
        }
        .tab-tiao.active {
            background-color: #2ecc71;
            color: white;
        }
        .tab-tong {
            background-color: #e5f3ff;
            color: #3498db;
            border: 2px solid #3498db;
        }
        .tab-tong.active {
            background-color: #3498db;
            color: white;
        }
        .num-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        .num-btn {
            padding: 12px 0;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .num-btn:hover {
            transform: scale(1.05);
        }
        .num-btn.wan {
            color: #e74c3c;
            background-color: #ffe5e5;
        }
        .num-btn.tiao {
            color: #2ecc71;
            background-color: #e5ffe7;
        }
        .num-btn.tong {
            color: #3498db;
            background-color: #e5f3ff;
        }
        .hand-cards {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            min-height: 100px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }
        .card {
            width: 45px;
            height: 65px;
            background-color: white;
            border: 2px solid #333;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .card:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .card.wan {
            color: #e74c3c;
        }
        .card.tiao {
            color: #2ecc71;
        }
        .card.tong {
            color: #3498db;
        }
        /* 新增：红中牌样式 */
        .card.hongzhong {
            background-color: #ffeeee;
            color: #e74c3c;
            border-color: #e74c3c;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .calc-btn {
            background-color: #27ae60;
            color: white;
        }
        .clear-btn {
            background-color: #e74c3c;
            color: white;
        }
        .result {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>川麻听牌计算器</h1>
        
        <!-- 新增：血流红中增强模式开关 -->
        <div class="enhance-mode">
            <span class="enhance-label">血流红中（百搭）</span>
            <label class="switch">
                <input type="checkbox" id="enhanceSwitch">
                <span class="slider"></span>
            </label>
        </div>

        <!-- 新增：红中/缺门设置区（默认隐藏） -->
        <div class="hongzhong-setting" id="hongzhongSetting">
            <div class="hongzhong-num">
                <label>红中数量：</label>
                <select id="hongzhongCount">
                    <option value="0">0张</option>
                    <option value="1">1张</option>
                    <option value="2">2张</option>
                    <option value="3">3张</option>
                    <option value="4">4张</option>
                </select>
            </div>
            <div class="quemen-select">
                <label>缺门花色：</label>
                <select id="quemenType">
                    <option value="none">不缺门</option>
                    <option value="wan">缺万</option>
                    <option value="tiao">缺条</option>
                    <option value="tong">缺筒</option>
                </select>
            </div>
        </div>

        <!-- 原有花色选择区 -->
        <div class="color-tabs">
            <button class="color-tab tab-wan active" data-type="wan">万</button>
            <button class="color-tab tab-tiao" data-type="tiao">条</button>
            <button class="color-tab tab-tong" data-type="tong">筒</button>
        </div>

        <!-- 原有数字选择区 -->
        <div class="num-buttons" id="numButtons">
            <button class="num-btn wan">1</button>
            <button class="num-btn wan">2</button>
            <button class="num-btn wan">3</button>
            <button class="num-btn wan">4</button>
            <button class="num-btn wan">5</button>
            <button class="num-btn wan">6</button>
            <button class="num-btn wan">7</button>
            <button class="num-btn wan">8</button>
            <button class="num-btn wan">9</button>
        </div>

        <!-- 原有手牌展示区 -->
        <div class="hand-cards" id="handCards"></div>

        <!-- 原有功能按钮区 -->
        <div class="action-buttons">
            <button class="action-btn calc-btn" id="calcBtn">算听牌</button>
            <button class="action-btn clear-btn" id="clearBtn">清空手牌</button>
        </div>

        <!-- 原有结果提示区 -->
        <div class="result" id="result"></div>
    </div>

<script>
// 原有全局变量
let currentType = 'wan';
let handCards = [];

// 新增：增强模式变量
let isEnhanceMode = false; // 是否开启血流红中
let hongzhongCount = 0;    // 红中数量
let quemenType = 'none';   // 缺门花色

// DOM元素（原有+新增）
const colorTabs = document.querySelectorAll('.color-tab');
const numButtons = document.getElementById('numButtons');
const handCardsEl = document.getElementById('handCards');
const calcBtn = document.getElementById('calcBtn');
const clearBtn = document.getElementById('clearBtn');
const resultEl = document.getElementById('result');
// 新增元素
const enhanceSwitch = document.getElementById('enhanceSwitch');
const hongzhongSetting = document.getElementById('hongzhongSetting');
const hongzhongCountSelect = document.getElementById('hongzhongCount');
const quemenTypeSelect = document.getElementById('quemenType');

// 原有：花色切换逻辑
colorTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    colorTabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentType = tab.dataset.type;
    document.querySelectorAll('.num-btn').forEach(btn => {
      btn.className = `num-btn ${currentType}`;
    });
  });
});

// 新增：增强模式开关逻辑
enhanceSwitch.addEventListener('change', () => {
  isEnhanceMode = enhanceSwitch.checked;
  hongzhongSetting.classList.toggle('show', isEnhanceMode);
  // 同步获取红中/缺门初始值
  hongzhongCount = parseInt(hongzhongCountSelect.value);
  quemenType = quemenTypeSelect.value;
});

// 新增：红中数量/缺门选择逻辑
hongzhongCountSelect.addEventListener('change', () => {
  hongzhongCount = parseInt(hongzhongCountSelect.value);
});
quemenTypeSelect.addEventListener('change', () => {
  quemenType = quemenTypeSelect.value;
});

// 原有：数字按钮点击加牌逻辑
numButtons.addEventListener('click', (e) => {
  if (e.target.classList.contains('num-btn')) {
    const num = parseInt(e.target.textContent);
    const cnt = handCards.filter(c => c.type === currentType && c.num === num).length;
    if (cnt >= 4) {
      showResult(`❌ 最多4张`, 'error');
      return;
    }
    handCards.push({ type: currentType, num });
    renderHandCards();
  }
});

// 原有：手牌渲染逻辑（新增红中展示）
function renderHandCards() {
  handCardsEl.innerHTML = '';
  
  // 1. 渲染普通手牌
  [...handCards].sort((a, b) => {
    if (a.type !== b.type) return a.type.localeCompare(b.type);
    return a.num - b.num;
  }).forEach((card, i) => {
    const el = document.createElement('div');
    el.className = `card ${card.type}`;
    el.textContent = card.num;
    el.onclick = () => {
      handCards.splice(i, 1);
      renderHandCards();
    };
    handCardsEl.appendChild(el);
  });

  // 2. 增强模式下渲染红中
  if (isEnhanceMode && hongzhongCount > 0) {
    for (let i = 0; i < hongzhongCount; i++) {
      const el = document.createElement('div');
      el.className = 'card hongzhong';
      el.textContent = '中';
      el.title = '红中（百搭）';
      handCardsEl.appendChild(el);
    }
  }
}

// 原有：清空手牌逻辑
clearBtn.onclick = () => {
  handCards = [];
  renderHandCards();
  resultEl.textContent = '';
};

// 核心：算听牌逻辑（兼容基础/增强模式）
calcBtn.onclick = () => {
  const totalCards = handCards.length + (isEnhanceMode ? hongzhongCount : 0);
  
  // 1. 基础数量校验
  if (![1,4,7,10,13].includes(totalCards)) {
    showResult(`❌ 总牌数${totalCards}：必须1/4/7/10/13`, 'error');
    return;
  }

  // 2. 基础花色校验（增强模式下自动适配缺门）
  let cardTypes = new Set(handCards.map(c => c.type));
  if (isEnhanceMode && quemenType !== 'none') {
    cardTypes.delete(quemenType); // 排除缺门花色
  }
  if (cardTypes.size > 2) {
    showResult(`❌ 有效花色${cardTypes.size}门：最多2门`, 'error');
    return;
  }

  // 3. 计算听牌（区分基础/增强模式）
  const ting = isEnhanceMode ? getTingWithHongzhong() : getTingBasic();
  
  if (ting.length === 0) {
    showResult(`❌ ${totalCards}张：不听`, 'error');
  } else {
    const text = ting.map(p => `${p.num}${{wan:'万',tiao:'条',tong:'筒'}[p.type]}`).join('、');
    showResult(`✅ ${totalCards}张：听 ${text}`, 'success');
  }
};

// 原有：基础模式听牌算法
function getTingBasic() {
  const all = [];
  for (const t of ['wan','tiao','tong']) {
    for (let n=1;n<=9;n++) all.push({type:t, num:n});
  }
  const res = [];
  for (const p of all) {
    const cnt = handCards.filter(c => c.type === p.type && c.num === p.num).length;
    if (cnt >=4) continue;
    if (isHuBasic([...handCards, p])) res.push(p);
  }
  return res;
}

// 新增：血流红中模式听牌算法（红中百搭）
function getTingWithHongzhong() {
  const all = [];
  // 排除缺门花色
  const validTypes = ['wan','tiao','tong'].filter(t => t !== quemenType);
  for (const t of validTypes) {
    for (let n=1;n<=9;n++) all.push({type:t, num:n});
  }
  
  const res = [];
  for (const p of all) {
    // 普通牌最多4张限制
    const cnt = handCards.filter(c => c.type === p.type && c.num === p.num).length;
    if (cnt >=4) continue;

    // 组合手牌+待选牌+红中
    const tempHand = [...handCards, p];
    if (isHuWithHongzhong(tempHand, hongzhongCount)) {
      res.push(p);
    }
  }
  return res;
}

// 原有：基础模式胡牌判定
function isHuBasic(cards) {
  const m = {};
  for (const {type, num} of cards) {
    const k = type + ',' + num;
    m[k] = (m[k] || 0) + 1;
  }
  const keys = Object.keys(m);
  for (const eye of keys) {
    if (m[eye] < 2) continue;
    const cp = { ...m };
    cp[eye] -= 2;
    if (cp[eye] === 0) delete cp[eye];
    if (checkGroup(cp)) return true;
  }
  return false;
}

// 新增：血流红中模式胡牌判定（红中百搭）
function isHuWithHongzhong(cards, hzCount) {
  // 递归尝试用红中替代任意牌，直到用完红中或胡牌
  function tryHu(tempCards, remainHz) {
    // 无红中时按基础规则判定
    if (remainHz === 0) {
      return isHuBasic(tempCards);
    }

    // 有红中时，尝试替代每一种可能的牌
    const validTypes = ['wan','tiao','tong'].filter(t => t !== quemenType);
    for (const t of validTypes) {
      for (let n=1;n<=9;n++) {
        // 该牌最多4张限制
        const cnt = tempCards.filter(c => c.type === t && c.num === n).length;
        if (cnt >=4) continue;
        
        // 加一张替代牌，减少一个红中
        const newCards = [...tempCards, {type:t, num:n}];
        if (tryHu(newCards, remainHz - 1)) {
          return true;
        }
      }
    }
    return false;
  }

  return tryHu(cards, hzCount);
}

// 原有：刻子/顺子校验逻辑
function checkGroup(g) {
  const m = { ...g };
  const keys = Object.keys(m).sort();
  for (const k of keys) {
    if (!m[k]) continue;
    const [t, nStr] = k.split(',');
    const n = parseInt(nStr);
    while (m[k] >= 3) {
      m[k] -= 3;
      if (m[k] === 0) delete m[k];
    }
    while (m[k] >= 1) {
      const a = t + ',' + (n+1);
      const b = t + ',' + (n+2);
      if (!m[a] || !m[b]) break;
      m[k]--; m[a]--; m[b]--;
      if (m[k] === 0) delete m[k];
      if (m[a] === 0) delete m[a];
      if (m[b] === 0) delete m[b];
    }
  }
  return Object.keys(m).length === 0;
}

// 原有：基础模式胡牌判定（内部调用）
function isHuBasic(cards) {
  const m = {};
  for (const {type, num} of cards) {
    const k = type + ',' + num;
    m[k] = (m[k] || 0) + 1;
  }
  const keys = Object.keys(m);
  for (const eye of keys) {
    if (m[eye] < 2) continue;
    const cp = { ...m };
    cp[eye] -= 2;
    if (cp[eye] === 0) delete cp[eye];
    if (checkGroup(cp)) return true;
  }
  return false;
}

// 原有：结果提示逻辑
function showResult(text, cls) {
  resultEl.className = `result ${cls}`;
  resultEl.textContent = text;
}

// 初始化
renderHandCards();
</script>
</body>
</html>